description: lora

target:
  service: amlk8s
  name: itp-scus-v100
  vc: AlexTScience

environment:
  image: wanglu315/traindte:aml
  registry: docker.io

storage:
  biglearndatamodelpublic:
    storage_account_name: biglearndatamodel
    container_name: tscience-public
    mount_dir: /mount/biglearndatamodelpublic

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: $CONFIG_DIR

search:
  job_template:
    # you may use {random_string:s} to avoid job name collisions
    # {auto:3s} generates lr_0.00000_mom_0.5, .. etc
    # {auto:2s} generates lr_0.00000_mo_0.5, .. etc
    name: hf_442_{auto:5s}
    sku: G8
    command:
    - . /opt/conda/bin/activate
    - conda deactivate
    - conda env create -f environment.yml
    - conda activate NLU
    - python -m pip install -e .
    - pip install loralib
    - export num_gpus=8
    - export CUBLAS_WORKSPACE_CONFIG=":16:8" # https://docs.nvidia.com/cuda/cublas/index.html#cublasApi_reproducibility
    - export PYTHONHASHSEED=0
    - export output_dir="/mount/biglearndatamodelpublic/models/adapter_exps/hf_442_glue/{task_name}/{auto:5s}"
    - python -m torch.distributed.launch --nproc_per_node=$$num_gpus \
    - examples/text-classification/run_glue.py \
    - --model_name_or_path roberta-large \
    - --task_name {task_name} \
    - --do_train \
    - --do_eval \
    - --evaluation_strategy epoch \
    - --save_strategy epoch \
    - --max_seq_length {len} \
    - --per_device_train_batch_size {bs} \
    - --per_device_eval_batch_size {bs} \
    - --learning_rate {lr} \
    - --num_train_epochs {epoch} \
    - --output_dir $$output_dir/model \
    # - --overwrite_output_dir \
    - --logging_steps 10 \
    - --logging_dir $$output_dir/log \
    # - --deepspeed ds_config.json \
    # - --fp16 \
    - --warmup_ratio 0.1 \
    - --apply_adapter \
    - --adapter_type {at} \
    - --adapter_size {adapter_size} \
    - --seed {seed}
  type: grid
  max_trials: 1
  params:
    - name: task_name
      spec: discrete
      values: ['mnli']
    - name: lr
      spec: discrete
      values: [3e-4]
    - name: epoch
      spec: discrete
      values: [5]
    - name: len
      spec: discrete
      values: [128]
    - name: bs
      spec: discrete
      values: [32]
    - name: at
      spec: discrete
      values: ['houlsby'] # houlsby pfeiffer
    - name: adapter_size
      spec: discrete
      values: [8]
    - name: seed
      spec: discrete
      values: [0]
